<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Create project</title>
        <link rel="stylesheet" type="text/css" href="style/project.css" >
        <style>
            #json {
                display: block;
            }
		</style>
        <script>
			var url = "rest/projects";

			var estimateArray;
			var priorityArray;
			var statusArray;

            window.addEventListener("load",initialise,false);

			function initialise(evt) {
			    fetchEstimates();
			    fetchPriorities();
			    fetchStatuses();
			    document.getElementById("create").addEventListener("click", create, false);
			}

   			function fetchEstimates() {
				var queryUrl = "rest/estimates";
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("GET", queryUrl, true);
				xmlhttp.addEventListener("readystatechange",handleEstimates,false);
				xmlhttp.setRequestHeader("Accept", "application/json");
				xmlhttp.send();
			}

		    function fetchPriorities() {
				var queryUrl = "rest/priorities";
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("GET", queryUrl, true);
				xmlhttp.addEventListener("readystatechange",handlePriorities,false);
				xmlhttp.setRequestHeader("Accept", "application/json");
				xmlhttp.send();
		    }

			function fetchStatuses() {
				var queryUrl = "rest/statuses";
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("GET", queryUrl, true);
				xmlhttp.addEventListener("readystatechange",handleStatuses,false);
				xmlhttp.setRequestHeader("Accept", "application/json");
				xmlhttp.send();
			}

			function handleEstimates(evt) {
    			if (evt.target.readyState == 4 ) {
    				if(evt.target.status == 200) {
    					estimateArray = JSON.parse(evt.target.responseText);
    			        var estimateSelect = document.getElementById("estimate");
        			    for(i = 0; i < estimateArray.length; i++) {
        			        var option = document.createElement('option');
							option.value = estimateArray[i].id;
							option.innerHTML = estimateArray[i].name;
							estimateSelect.appendChild(option);
        			    }
    				}
    				else if(evt.target.status == 404) {
    					sessionStorage.setItem("error", "Unable to load estimates");
						window.location.href = "error.html";
    				}
    				else {
    					sessionStorage.setItem("error", "Unexpected response status " + evt.target.status);
						window.location.href = "error.html";
					}
			    }
			}

			function handlePriorities(evt) {
    			if (evt.target.readyState == 4 ) {
    				if(evt.target.status == 200) {
    					var jsArray = JSON.parse(evt.target.responseText);
    			        var prioritySelect = document.getElementById("priority");
        			    for(i = 0; i < jsArray.length; i++) {
        			        var option = document.createElement("option");
							option.value = jsArray[i].id;
							option.innerHTML = jsArray[i].name;
							prioritySelect.appendChild(option);
        			    }
    				}
    				else if(evt.target.status == 404) {
    					sessionStorage.setItem("error", "Unable to load priorities");
						window.location.href = "error.html";
    				}
    				else {
    					sessionStorage.setItem("error", "Unexpected response status " + evt.target.status);
						window.location.href = "error.html";
					}
			    }
			}

			function handleStatuses(evt) {
    			if (evt.target.readyState == 4 ) {
    				if(evt.target.status == 200) {
    					var jsArray = JSON.parse(evt.target.responseText);
    			        var statusSelect = document.getElementById("status");
        			    for(i = 0; i < jsArray.length; i++) {
        			        var option = document.createElement("option");
							option.value = jsArray[i].id;
							option.innerHTML = jsArray[i].name;
							statusSelect.appendChild(option);
        			    }
    				}
    				else if(evt.target.status == 404) {
    					sessionStorage.setItem("error", "Unable to load statuses");
						window.location.href = "error.html";
    				}
    				else {
    					sessionStorage.setItem("error", "Unexpected response status " + evt.target.status);
						window.location.href = "error.html";
					}
			    }
			}

            function create(evt) {
                //alert("Create ...");
                // fetch data
                var description = document.getElementById("description").value;
                //alert("description = " + description);
				var goals = document.getElementById("goals").value;
				//alert("goals = " + goals);
				var actions = document.getElementById("actions").value;
				var start = document.getElementById("start").value;
				var deadline = document.getElementById("deadline").value;
				//alert("deadline = " + deadline);
				var estimate_id = document.getElementById("estimate").value;
				//alert("estimate_id = " + estimate_id);
				//var priority = document.getElementById("priority").value;
				//var status = document.getElementById("status").value;
				// build JSON project object
                var projectObject = new Object();
                projectObject.description = description;
                projectObject.goals = goals;
                projectObject.actions = actions;
                projectObject.start = start;
                projectObject.deadline = deadline;
                var estimateObject = new Object();
                estimateObject.id = estimate_id;
                estimateObject.name = "";
                projectObject.estimate = estimateObject;
                //jsObject.estimate.id = estimate_id;
                //js.Object.estimate.name = estimateArray[parseInt()].name;
                //jsObject.actions = actions;
                //jsObject.actions = actions;

                document.getElementById("json").innerHTML= JSON.stringify(projectObject, null, 2);
                // TODO: Send to server and view result
            }


        </script>
    </head>
    <body>
        <h1>Self study: Create project</h1>
        <p>
            <input type="text" readonly value="-" maxlength="3" size="3" style="font-weight: bold" >
            <input type="text" maxlength="32" size="32" style="font-weight: bold" id="description">
        </p>
        <p style="margin-bottom: 0"><b>Goals:</b></p>
        <textarea  maxlength="2048" id="goals"></textarea>
        <p style="margin-bottom: 0"><b>Actions:</b></p>
        <textarea  maxlength="2048" id="actions"></textarea>
        <table style="margin-top: 12px">
            <tr>
                <td><b>Start</b></td>
                <td><input type="date" id="start"></td>
            </tr>
            <tr>
                <td><b>Deadline</b></td>
                <td><input type="date" id="deadline"></td>
            </tr>
            <tr>
                <td><b>Estimate</b></td>
                <td><select id="estimate"></select></td>
            </tr>
            <tr>
                <td><b>Priority</b></td>
                <td><select id="priority"></select></td>
            </tr>
            <tr>
                <td><b>Status</b></td>
                <td><select id="status"></select></td>
            </tr>
        </table>
        <p><button id="create">Create</button></p>
        <p><a href="index.html">Home</a></p>
        <pre id="json">&nbsp;</pre>
    </body>
</html>